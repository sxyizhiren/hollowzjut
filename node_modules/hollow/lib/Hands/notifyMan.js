/**
 * Created with JetBrains WebStorm.
 * User: Administrator
 * Date: 13-5-9
 * Time: 下午9:13
 * To change this template use File | Settings | File Templates.
 */


var Request=require('node-request');

var NotifyMan=function(){

    var maxMsgLen;

    var cookie;

    var notifys;

    var callbackfn;

    var msgList;

    this.getNotifys=function(cookieStr,maxLen,callback){
        cookie=cookieStr;   //实际是一个cookie对象

        if(typeof maxLen == 'number'){
            maxMsgLen = Math.ceil(maxLen);//大于等于其数值的最小整数
        }

        if(typeof callback == 'function'){
            callbackfn = callback;
        }

        if(cookie && maxMsgLen){
            notifys={};
            //console.log('get notifys');
            var url='http://notify.renren.com/rmessage/get?getbybigtype=1&bigtype=1&limit='+maxMsgLen+'&begin=0&view=17';
            Request.get(url,cookie,null,notifys,'txt',washNotifys);
        }
    }

    /**
     * renren接口返回有错误，把冒号写成逗号了
     * @param notify
     */
    var fixRenrenBug=function(notify){
        //修正一个人人接口的bug
        var tag= /\{"comment"\,"回复/g;
        var fix='{"comment":"回复';
        if(typeof(notify.Content) === 'string'){
            notify.Content=notify.Content.replace(tag,fix).replace(/\n/g,'');//好脆弱连换行符都不能接受
        }

        try{
            notify.Content=JSON.parse(notify.Content);
            notify.parseStatus=true;
        }catch(e){
            notify.parseStatus=false;
        }
    }

    /**
     * 把消息转成统一格式
     */
    var washNotifys=function(){
        msgList=[];
        //修正内容并JSON it
        //console.log(notifys);
        fixRenrenBug(notifys);
        //console.log(notifys);
        if(notifys.parseStatus && typeof(notifys.Content)=='object'){
            for(i=0;i<notifys.Content.length;i++){
                var notify=notifys.Content[i];
                var type=parseInt(notify.type);
                var aNotify={};
                switch(type){
                    case 196:   //被@了
                        aNotify.type=type;
                        aNotify.ownerID=notify.owner;
                        aNotify.doingID=notify.doing_id;
                        aNotify.doingContent=notify.doing_content;
                        aNotify.fromID=notify.from;
                        aNotify.fromName=notify.from_name;
                        aNotify.comm=notify.reply_content;
                        aNotify.sourceID=notify.source;
                        aNotify.replyID=notify.replied_id;
                        aNotify.notifyID=notify.notify_id;
                        aNotify.removeUrl='http://notify.renren.com/rmessage/remove?nl='+notify.notify_id;
                        msgList.push(aNotify);
                        break;
                    case 142:    //也是被回复了
                        /*
                         {
                         "comment":"回复秘密小纸条：777",
                         "source" : "4857590855",
                         "owner" : "601709198",
                         "from" : "430040464",
                         "type" : "142",
                         "time" : "1371843032",
                         "from_name" : "李宏波",
                         "doing_content" : "hhhhkkkkkkkkkkkkkkkkk【From -】",
                         "notify_id" : "43910784504",
                         "status_id" : "4857590855",
                         "comment_id" : "15184811046",
                         "curpage" : "0"
                         }
                         */
                        aNotify.type=type;
                        aNotify.ownerID=notify.owner;
                        aNotify.doingID=notify.status_id;
                        aNotify.fromID=notify.from;
                        aNotify.fromName=notify.from_name;
                        aNotify.replyID=notify.comment_id;
                        aNotify.comm=notify.comment;
                        aNotify.notifyID=notify.notify_id;
                        aNotify.removeUrl='http://notify.renren.com/rmessage/remove?nl='+notify.notify_id;
                        msgList.push(aNotify);
                        break;
                    case 16:    //被回复了
                        aNotify.type=type;
                        aNotify.ownerID=notify.owner;
                        aNotify.doingID=notify.doing_id;
                        aNotify.fromID=notify.from;
                        aNotify.fromName=notify.from_name;
                        aNotify.replyID=notify.replied_id;
                        aNotify.comm=notify.reply_content;
                        aNotify.notifyID=notify.notify_id;
                        aNotify.removeUrl='http://notify.renren.com/rmessage/remove?nl='+notify.notify_id;
                        msgList.push(aNotify);
                        break;
                    case 14:    //新的留言，主页不回收到这类信息
                        aNotify.type=type;
                        aNotify.ownerID=notify.owner;
                        aNotify.fromID=notify.from;
                        aNotify.fromName=notify.from_name;
                        aNotify.whisper=notify.whisper=='&whisper=1'?1:0;
                        aNotify.comm=notify.msg_context;
                        aNotify.notifyID=notify.notify_id;
                        aNotify.removeUrl='http://notify.renren.com/rmessage/remove?nl='+notify.notify_id;
                        msgList.push(aNotify);
                        break;
                    case 24:    //新的站内信
                        aNotify.type=type;
                        aNotify.ownerID=notify.owner;
                        aNotify.fromID=notify.from;
                        aNotify.fromName=notify.from_name;
                        aNotify.comm=notify.msg_context;//永远是''
                        aNotify.sourceID=notify.source;//站内信的id标志这一封站内信
                        aNotify.notifyID=notify.notify_id;
                        aNotify.removeUrl='http://notify.renren.com/rmessage/remove?nl='+notify.notify_id;
                        msgList.push(aNotify);
                        break;
                    default:
                        aNotify.type=type;
                        aNotify.notifyID=notify.notify_id;
                        aNotify.removeUrl='http://notify.renren.com/rmessage/remove?nl='+notify.notify_id;
                        msgList.push(aNotify);
                        break;
                }

            }
        }
        if(typeof callbackfn == 'function'){
            callbackfn(msgList);
        }
    }

}

exports.INST=NotifyMan;


/**
 各种
 状态栏 @ {
	"reply_content" : "@秘密小纸条(601709198) mmmmmm",
 "imgUrl" : "",
 "source" : "4860109138",
 "owner" : "430040464",
 "from" : "430040464",
 "type" : "196",
 "time" : "1371841694",
 "from_name" : "李宏波",
 "doing_id" : "4860109138",
 "doing_content" : "@秘密小纸条(601709198) mmmmmm",
 "replied_id" : "430040464",
 "feed_stype" : "502",
 "feed_actor" : "430040464",
 "from_pic" : "http://hdn.xnimg.cn/photos/hdn521/20111122/0815/tiny_Wrvx_99284o019118.jpg",
 "msg_context" : "",
 "notify_id" : "43910733111"
 }
 回复栏 @ {
	"reply_content" : "@秘密小纸条(601709198) ppp",
 "imgUrl" : "",
 "source" : "4857567538",
 "owner" : "430040464",
 "from" : "430040464",
 "type" : "196",
 "time" : "1371841545",
 "from_name" : "李宏波",
 "doing_id" : "4857567538",
 "doing_content" : "ssssssssssssssssssssssssssssssssssssss",
 "replied_id" : "15184800670",
 "feed_stype" : "502",
 "feed_actor" : "430040464",
 "from_pic" : "http://hdn.xnimg.cn/photos/hdn521/20111122/0815/tiny_Wrvx_99284o019118.jpg",
 "msg_context" : "",
 "notify_id" : "43910726995"
 }
 回复 {
	"source" : "4857567538",
	"owner" : "430040464",
	"from" : "430040464",
	"type" : "16",
	"time" : "1371841474",
	"from_name" : "李宏波",
	"doing_id" : "4857567538",
	"doing_content" : "ssssssssssssssssssssssssssssssssssssss",
	"replied_id" : "15184800141",
	"feed_stype" : "502",
	"feed_actor" : "430040464",
	"from_pic" : "http://hdn.xnimg.cn/photos/hdn521/20111122/0815/tiny_Wrvx_99284o019118.jpg",
	"reply_content" : "回复秘密小纸条: xxx",
	"feed_source" : "4857567538",
	"notify_id" : "43910724121"
}

 另一种回复
 {
     "comment":"回复秘密小纸条：777",
     "source" : "4857590855",
     "owner" : "601709198",
     "from" : "430040464",
     "type" : "142",
     "time" : "1371843032",
     "from_name" : "李宏波",
     "doing_content" : "hhhhkkkkkkkkkkkkkkkkk【From -】",
     "notify_id" : "43910784504",
     "status_id" : "4857590855",
     "comment_id" : "15184811046",
     "curpage" : "0"
 }
 别人状态栏@
 [{"reply_content":"@树洞ZJUT(601715540) (叹气)","imgUrl":"","source":"4886878518","owner":"328148094","from":"430040464","type":"196","time":"1373092066","from_name":"李宏波","doing_id":"4886878518","doing_content":"考试的结束意味着大三的结束！三年就这样过去了！开学寝室也就只剩二个人了！伤感！珍惜珍惜再珍惜！","replied_id":"15257640391","feed_stype":"502","feed_actor":"328148094","from_pic":"http://hdn.xnimg.cn/photos/hdn521/20111122/0815/tiny_Wrvx_99284o019118.jpg","msg_context":"","notify_id":"44243966112"}]
 */