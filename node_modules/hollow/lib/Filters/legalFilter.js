var commonTester=require('./commonTester');
var testList=commonTester.testList;

var Tools=require('../shareTool');
var msgType=Tools.messageType;


/**
 * 要过滤的关键字
 * @type {Array}
 */
var sensitiveWords = [
    'zjut_treehole' //防止浙工大树洞的自我宣传被我拷贝
    ,'12星座'         //星座话题过滤掉
    ,'张昭洪'      //这人老发寻人启事，
    ,'促销活动'     //广告啊
    ,'约炮'       //重口味
    ,'撸管'       //重口味
    ,'黑木耳'      //重口味
    ,'鲁哩噜'      //那个sb的口头禅
    ,'gay'      //gay话题过滤掉
    ,'不相信树洞'    //怎么可以不相信呢
    ,'啪啪啪'//呵呵
    ,'操她'  //
    ,'被操'   //
    ,'做爱'    //
    ,'树洞秘密'////sb一直问
    ,'秘密树洞'//sb一直问
    ,'截舞泰'  //广告！！
    ,'18758230845'//同上，他的报名电话
    ,'取消关注树洞'//
   // ,'转自'       //转的不要,      (转来的也可以发布)
    ,'微信号'      //微信宣传走你
    ,'jiehunba77'   //神补刀宣传的微信号
    ,'18767123152'  //考证广告报名电话
    ,'兼职'//招兼职
    ,'VIP会员服务'  //会员信息
    ,'价格优惠' //广告
    ,'校会招新' //校会招新太多了
    ,'【活动预告】'//校会的
];

/**
 * 要过滤的模式
 * @type {Array}
 */
var sensitivePatterns=[
    /回复.{1,20}:/            //回复的内容不发表
    ,/喜欢.{1,8}请转发/     //求转发的过滤掉
    ,/上架.{1,6}商品/           //广告
    ,/搞大.{1,14}的肚子/         //
    ,/全家.{0,5}死光/        //骂人
    ,/发生.{0,5}关系/        //
    //允许链接了，因为棱镜需要发布链接到日志的消息。但是其他主页留言板的链接消息已经在hand中被过滤掉了
    //,/(http:\/\/)?([\w]{1,10}\.){1,3}(com|net|cn|org)/gi    //外链禁止,
    ,/树洞.{0,3}秘密/,      //一直问
    ,/秘密.{0,3}树洞/       //一直问
    ,/蒋.{0,1}贤.{0,1}林/  //受不了了
];


/**
 * 是否包含违禁词或模式
 * @param str
 * @return {*}
 */
function test(str){
    return testList(str,sensitiveWords) || testList(str,sensitivePatterns);
}

/**
 * 是否字符串非法
 * @param str
 * @return {Boolean}
 */
function otherIllegal(str){
    return (typeof str !== 'string')
        || (str.length <= 8)
        || (str.indexOf('「') >=0 && str.indexOf('「') <= 8) ;
}

function filter(messageBody){
    if(messageBody.messageid === msgType.textType){
        if(otherIllegal(messageBody.message) || test(messageBody.message)){
            //直接当作错误处理掉
            messageBody.messageid=msgType.errorType;
        }
    }else if(messageBody.messageid === msgType.imgDespt){
        //相册描述也要过滤关键字,但不限制字数
        if(test(messageBody.message.descriptions)){
            //直接当作错误处理掉
            messageBody.messageid=msgType.errorType;
        }
    }
    return messageBody;
}

exports.filter=filter;


