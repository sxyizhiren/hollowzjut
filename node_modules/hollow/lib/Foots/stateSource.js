/**
 * Created with JetBrains WebStorm.
 * User: Administrator
 * Date: 13-5-6
 * Time: 上午12:08
 * To change this template use File | Settings | File Templates.
 */

var Request=require('node-request');
var assert=require('assert');

var GossipSource=function(){

    var maxMsgLen;

    var pageId;

    var cookie;

    var gossipHtml;

    var callbackfn;

    var msgList;

    /**
     * maxlen为0则返回全部json数据，大于0则只返回n条状态的数组
     * @param pageid
     * @param cookieStr
     * @param maxLen
     * @param callback
     */
    this.getStateList=function(pageid,cookieStr,maxLen,callback){
        maxMsgLen = maxLen;
        pageId=pageid;
        cookie=cookieStr;   //实际上是一个cookie对象

        if(typeof callback == 'function'){
            callbackfn = callback;
        }

        if(pageId && cookie){
            gossipHtml={};
            //console.log('get state['+pageId+']');
            var url='http://status.renren.com/GetSomeomeDoingList.do?userId='+pageId +'&curpage=0';
            Request.get(url,cookie,null,gossipHtml,'json',washStateHtml);
        }
    }

    var washStateHtml=function(){
        assert(typeof callbackfn === 'function');
        if(maxMsgLen > 0){
            msgList=[];
            if(gossipHtml.Content && gossipHtml.parseStatus){
                var doingList=gossipHtml.Content.doingArray;
                for(var i=0;i<doingList.length;i++){
                    var doing=doingList[i];
                    var msg={
                        id:doing.id,
                        content:doing.content,
                        owner:doing.userId
                    };
                    if(doing.rootContent && (doing.content.indexOf('转自') >=0)){
                        //doing.rootContent存在说明是转来的，(msg.content.indexOf('转自')起验证作用
                        //转来就转原始内容
                        msg.content=doing.rootContent;
                    }
                    msgList.push(msg);
                    if(msgList.length >= maxMsgLen){
                        break;
                    }
                }

            }
            if(msgList.length <= 0){
                //便于查看是不是需要验证码什么的
                console.log(gossipHtml);
            }
            callbackfn(pageId,msgList);
        }else{
            if(gossipHtml.Content && gossipHtml.parseStatus){
                callbackfn(pageId,gossipHtml);
            }else{
                callbackfn(pageId,{});
            }
        }
    }

}

exports.INST=GossipSource;

